# Disable directory browsing
Options -Indexes

# Enable symbolic links
Options +SymLinksIfOwnerMatch

# Enable the rewrite engine
RewriteEngine On

# Set the base directory
RewriteBase /

# Security headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always append X-Frame-Options SAMEORIGIN
    
    # Prevent MIME-type sniffing
    Header set X-Content-Type-Options nosniff
    
    # XSS protection
    Header set X-XSS-Protection "1; mode=block"
    
    # Referrer policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Feature policy
    Header set Feature-Policy "geolocation 'self'; microphone 'self'; camera 'self'"
</IfModule>

# Block suspicious requests
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (\.\.\/|\.\.\\) [NC,OR]
    RewriteCond %{QUERY_STRING} (localhost|loopback|127\.0\.0\.1) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|>|'|\"|\)|\(|%3c|%3e|%22|%27|%3d|%29|%28) [NC,OR]
    RewriteCond %{QUERY_STRING} (;|<|>|'|"|\)|\(|%3c|%3e|%22|%27|%3b|%3d|%3a) [NC,OR]
    RewriteCond %{QUERY_STRING} (benchmark|union|declare|cast|convert|exec|execute|chr|concat|substring|nchar|varchar|nvarchar) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Block access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|sql)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block access to backup and source files
<FilesMatch "\.(bak|backup|old|orig|save|swp|tmp)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block access to composer files
<Files composer\.json>
    Order Allow,Deny
    Deny from all
</Files>

# Block access to environment files
<Files \.env>
    Order Allow,Deny
    Deny from all
</Files>

# Force HTTPS (uncomment if SSL is configured)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redirect www to non-www (uncomment if needed)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Prevent access to error logs
<FilesMatch "^.*\.(log|ini)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Set cache control for static files
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
</IfModule>

# Compress text files
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Set security headers for HTML files
<IfModule mod_headers.c>
    <FilesMatch "\.(html|htm|php)$">
        Header set X-Content-Type-Options "nosniff"
        Header set X-Frame-Options "SAMEORIGIN"
        Header set X-XSS-Protection "1; mode=block"
    </FilesMatch>
</IfModule>

# Prevent access to hidden files and directories
RewriteCond %{SCRIPT_FILENAME} -d [OR]
RewriteCond %{SCRIPT_FILENAME} -f
RewriteRule "(^|/)\." - [F]

# Rewrite conditions for existing files and directories
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Чистые URL для страниц
RewriteRule ^catalog$ catalog.php [L]
RewriteRule ^payment_delivery$ payment_delivery.php [L]
RewriteRule ^calculator$ calculator.php [L]
RewriteRule ^about$ about.php [L]
RewriteRule ^contacts$ contacts.php [L]
RewriteRule ^login/?$ login.php [L]
RewriteRule ^register$ register.php [L]
RewriteRule ^myacon/process$ myacon/process.php [L]
RewriteRule ^logout$ logout.php [L]
RewriteRule ^product$ product.php [L]
RewriteRule ^requirements$ requirements.php [L]
RewriteRule ^privacy$ privacy.php [L]
RewriteRule ^terms$ terms.php [L]
RewriteRule ^forgot-password$ forgot-password.php [L]
RewriteRule ^reset-password$ reset-password.php [L]
RewriteRule ^service/([0-9]+)$ service.php?id=$1 [L,QSA]
RewriteRule ^service$ service.php [L,QSA]
RewriteRule ^cart$ cart.php [L,QSA]
RewriteRule ^api/cart-count$ api/cart-count.php [L,QSA]
RewriteRule ^cart/add$ cart0/add.php [L,QSA]
RewriteRule ^cart/remove$ cart0/remove.php [L,QSA]
RewriteRule ^checkoutcart$ checkout.php [L,QSA]
RewriteRule ^checkoutshopcart/process$ checkoutshopcart/process.php [L,QSA]
RewriteRule ^checkoutshopcart/confirmation$ checkoutshopcart/comfirmation.php [L,QSA]

# Админ-панель
RewriteRule ^admin$ admin/index.php [L]
RewriteRule ^admin/orders$ admin/orders.php [L]
RewriteRule ^admin/managers$ admin/managers.php [L]
RewriteRule ^admin/calculator-settings$ admin/calculator-settings.php [L]
RewriteRule ^admin/edit-product$ admin/edit-product.php [L]
RewriteRule ^admin/register$ admin/register.php [L]
RewriteRule ^admin/users$ admin/users.php [L]
RewriteRule ^admin/products$ admin/products.php [L]
RewriteRule ^admin/product/edit$ admin/product/edit.php [L]
RewriteRule ^admin/product/manage_expenses$ admin/product/manage_expenses.php [L,QSA]
RewriteRule ^admin/attributes$ admin/attributes.php [L]
RewriteRule ^admin/discounts$ admin/discounts.php [L]
RewriteRule ^admin/tax_settings$ admin/tax_settings.php [L]
RewriteRule ^admin/order/add_external$ admin/order/add_external.php [L,QSA]
RewriteRule ^admin/order/external_details$ admin/order/external_details.php [L,QSA]
RewriteRule ^admin/order/external_orders$ admin/order/external_orders.php [L,QSA]
RewriteRule ^admin/images$ admin/images.php [L,QSA]
RewriteRule ^admin/image/delete$ admin/image/delete.php [L,QSA]
RewriteRule ^admin/partners$ admin/partners.php [L,QSA]
RewriteRule ^admin/seo/home$ admin/seo/index.php [L,QSA]
RewriteRule ^admin/statistic$ admin/statistic.php [L,QSA]
RewriteRule ^admin/order/details/([0-9]+)$ admin/order/details.php?id=$1 [L,QSA]
RewriteRule ^admin/order/details$ admin/order/details.php [L,QSA]
RewriteRule ^admin/buhgalt/orderdetail$ admin/buhgalt/order_detail.php [L,QSA]
RewriteRule ^admin/buhgalt/addexpense$ admin/buhgalt/add_expense.php [L,QSA]
RewriteRule ^admin/buhgalt/index$ admin/buhgalt/index.php [L,QSA]
RewriteRule ^admin/buhgalt/add_external_order$ admin/buhgalt/add_external_order.php [L,QSA]
RewriteRule ^admin/buhgalt/add_payment$ admin/buhgalt/add_payment.php [L,QSA]
RewriteRule ^admin/buhgalt/add_expense$ admin/buhgalt/add_expense.php [L,QSA]
RewriteRule ^admin/buhgalt/add_general_expense$ admin/buhgalt/add_general_expense.php [L,QSA]
RewriteRule ^admin/orderform$ admin/order_form.php [L,QSA]
RewriteRule ^admin/contacts/messages$ admin/contacts/messages.php [L,QSA]
RewriteRule ^admin/materials$ admin/materials/index.php [L,QSA]
RewriteRule ^admin/materials/add$ admin/materials/add.php [L,QSA]
RewriteRule ^admin/materials/edit$ admin/materials/edit.php [L,QSA]
RewriteRule ^admin/materials/movements$ admin/materials/movements.php [L,QSA]
RewriteRule ^admin/materials/movementadd$ admin/materials/movement_add.php [L,QSA]
RewriteRule ^admin/tasks/add$ admin/tasks/add.php [L,QSA]
RewriteRule ^admin/telegram_setup$ admin/telegram_setup.php [L,QSA]
RewriteRule ^admin/messaging/create$ admin/messaging/create.php [L,QSA]
RewriteRule ^admin/messaging/send$ admin/messaging/send.php [L,QSA]
RewriteRule ^admin/messaging/send_messages$ admin/messaging/send_messages.php [L,QSA]
RewriteRule ^admin/messaging/details$ admin/messaging/details.php [L,QSA]
RewriteRule ^admin/messaging/edit$ admin/messaging/edit.php [L,QSA]
RewriteRule ^admin/notifications$ admin/notifications.php [L,QSA]
RewriteRule ^admin/suppliers$ admin/suppliers/index.php [L,QSA]
RewriteRule ^admin/suppliers/add$ admin/suppliers/add.php [L,QSA]
RewriteRule ^admin/suppliers/edit$ admin/suppliers/edit.php [L,QSA]
RewriteRule ^admin/suppliers/details$ admin/suppliers/details.php [L,QSA]

# Личный кабинет
RewriteRule ^client/dashboard$ client/dashboard.php [L,QSA]
RewriteRule ^client/settings$ client/settings.php [L,QSA]
RewriteRule ^client/orders$ client/orders.php [L,QSA]
RewriteRule ^client/mini_warehouse$ client/mini_warehouse.php [L,QSA]

# Custom error documents
ErrorDocument 400 /404.php
ErrorDocument 401 /404.php
ErrorDocument 403 /404.php
ErrorDocument 404 /404.php
ErrorDocument 500 /404.php

# Защита от доступа к .htaccess
<Files .htaccess>
    Order allow,deny
    Deny from all
</Files>